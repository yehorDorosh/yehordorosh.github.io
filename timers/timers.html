<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title>TIMERS</title>
    <style>
        .progress {
            width: 100%;
            height: 20px;
            border: solid 1px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .progress::before {
            content: '';
            position: absolute;
            left: -1px;
            top: 50%;
            transform: translateY(-50%);
            height: 90%;
            width: 0%;
            background: #5bc1fe;
            border: 1px solid #008DF2;
            border-radius: 5px;
            box-shadow: 3px 0 3px rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
    </style>
</head>

<body>
    <form id="form-create-timer">
        <input type="button" value="add timer" id="add-timer" />
    </form>
    <script>
        'use strict'


        var UID = {
            _current: 0,
            getNew: function() {
                this._current++;
                return this._current;
            }
        };

        HTMLElement.prototype.pseudoStyle = function(element, prop, value) {
            var _this = this;
            var _sheetId = "pseudoStyles";
            var _head = document.head || document.getElementsByTagName('head')[0];
            var _sheet = document.getElementById(_sheetId) || document.createElement('style');
            _sheet.id = _sheetId;
            var className = "pseudoStyle" + UID.getNew();

            _this.className += " " + className;

            _sheet.innerHTML += " ." + className + ":" + element + "{" + prop + ":" + value + "}";
            _head.appendChild(_sheet);
            return this;
        };



        let formCreateTimer = document.getElementById('form-create-timer');
        let btnAddTimer = document.getElementById('add-timer');
        let listForms = [];
        let audio = new Audio();
        audio.preload = 'auto';
        audio.src = '808bdO.ogg';
        audio.media = 'screen';

        function CreateObjTimer(start, setPoint, id) {
            this.id = id;
            this.start = start;
            this.setPoint = setPoint * 1000;
            this.startTime;
            this.endTime;
            this.leftTime;
            this.passTime;
            this.finish;
            this.timerOn = function(setPoint) {
                this.finish = false;
                this.setPoint = (setPoint * 1000) || this.setPoint;
                this.startTime = Date.now();
                this.endTime = this.startTime + this.setPoint;
                this.scaner = setInterval(this.readDataTimer.bind(this), 1000);
            }
            this.readDataTimer = function() {
                this.leftTime = Math.abs(Math.round((this.endTime - Date.now()) / 1000));
                //console.log(this.leftTime);
                this.passTime = Date.now() - this.startTime;
                this.screenLeftTime(this.leftTime);

                if (Date.now() >= this.endTime) {
                    clearInterval(this.scaner);
                    audio.play();
                    this.start = false;
                    this.finish = true;
                }
            }
            this.screenLeftTime = function(sec) {
                let form = document.getElementById(this.id);
                let elem = form.getElementsByTagName('DIV');
                elem[0].innerText = secToTime(sec);
                elem[0].pseudoStyle("before", "width", `${this.passTime * 100 / this.setPoint}%`);
            }
        }

        function createTimer(parent) {
            let formTimer = document.createElement('form');
            if (listForms.length == 0) {
                formTimer.id = 0;
                listForms.push(true);
            } else {
                for (let i = 0; i < listForms.length; i++) {

                    if (listForms[i] == false) {
                        formTimer.id = i;
                        listForms[i] = true;
                        break;
                    }
                    if (i == listForms.length - 1) {
                        formTimer.id = i + 1;
                        listForms.push(true);
                        break;
                    }
                }
            }

            let btnDeleteTimer = document.createElement('input');
            btnDeleteTimer.type = 'button';
            btnDeleteTimer.value = 'delete timer';
            btnDeleteTimer.name = 'delete timer';
            let btnStartTimer = document.createElement('input');
            btnStartTimer.type = 'button';
            btnStartTimer.value = 'start timer';
            btnStartTimer.name = 'start timer';

            let fieldSetTimeM = document.createElement('input');
            fieldSetTimeM.type = 'number';
            fieldSetTimeM.placeholder = "min"
            fieldSetTimeM.name = 'setPointMin'
            fieldSetTimeM.value = 0;
            fieldSetTimeM.min = 0;
            fieldSetTimeM.max = 9999;

            let fieldSetTimeS = document.createElement('input');
            fieldSetTimeS.type = 'number';
            fieldSetTimeS.placeholder = "sec"
            fieldSetTimeS.name = 'setPointSec'
            fieldSetTimeS.value = 5;
            fieldSetTimeS.min = 1;
            fieldSetTimeS.max = 59;

            let fieldRestTime = document.createElement('div');
            fieldRestTime.innerText = '0:0';
            fieldRestTime.className = 'progress';

            let br = document.createElement('br');

            parent.appendChild(formTimer);
            formTimer.appendChild(fieldSetTimeM);
            formTimer.appendChild(fieldSetTimeS);
            formTimer.appendChild(btnStartTimer);
            formTimer.appendChild(btnDeleteTimer);
            formTimer.appendChild(br);
            formTimer.appendChild(fieldRestTime);

            listForms[formTimer.id] = new CreateObjTimer(false, 5, formTimer.id);
        }

        btnAddTimer.addEventListener('click', function() {
            createTimer(document.body);

        });

        function timeToSec(min, sec) {
            min = parseInt(min);
            sec = parseInt(sec);
            let result = (min * 60) + sec;
            return result;
        }

        function secToTime(sec) {
            sec = parseInt(sec);
            let tSec = sec % 60;
            let tMin = ~~(sec / 60);
            return tMin + ':' + tSec;
        }

        function getDecimal(num) {
            var str = "" + num;
            var zeroPos = str.indexOf(".");
            if (zeroPos == -1) return 0;
            str = str.slice(zeroPos);
            return +str;
        }

        document.body.addEventListener('click', function(e) {
            let target = e.target;
            if (target.name == 'delete timer') {
                clearInterval(listForms[target.parentNode.id].scaner);
                listForms[target.parentNode.id] = false;
                target.parentNode.remove();
            }

            if (target.name == 'start timer') {
                let form = target.parentNode;
                listForms[target.parentNode.id].timerOn(timeToSec(form[0].value, form[1].value));
            }
            if (target.name == 'setPointSec') {
                target.onblur = () => {
                    if (target.value > 59) target.value = 59;
                    if (target.value < 1) target.value = 1;
                }
            }
            if (target.name == 'setPointMin') {
                target.onblur = () => {
                    if (target.value > 9999) target.value = 9999;
                    if (target.value < 0) target.value = 0;
                }
            }

        });
    </script>
</body>

</html>